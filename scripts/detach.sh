#!/bin/bash
# Скрипт для запуска процесса с двойным fork (полное отделение от родителя)

# Аргументы: 
# $1 - путь к лог-файлу
# $2 - путь к исполняемому файлу
# $3+ - аргументы для исполняемого файла

if [ $# -lt 2 ]; then
    echo "Usage: $0 <log_file> <executable> [args...]" >&2
    exit 1
fi

LOG_FILE="$1"
EXEC_PATH="$2"
shift 2
EXEC_ARGS=("$@")

# Двойной fork для создания независимого процесса
(
    # Первый fork - создаем промежуточный процесс
    # setsid отделяет от терминала и создает новую сессию
    setsid bash -c '
        # Второй fork - создаем финальный процесс
        (
            # Закрываем стандартные потоки
            exec 0</dev/null
            exec 1>>"'"$LOG_FILE"'" 2>&1
            
            # Записываем в лог начало
            echo "[$(date '\''+%Y-%m-%d %H:%M:%S'\'')] [DETACH] Starting: '"$EXEC_PATH"' '"${EXEC_ARGS[*]}"'"
            
            # Запускаем финальный процесс
            exec "'"$EXEC_PATH"'" '"$(printf '"%s" ' "${EXEC_ARGS[@]}")"'
        ) &
        
        # Промежуточный процесс завершается сразу
        exit 0
    ' &
)

# Родительский процесс сразу завершается
exit 0
