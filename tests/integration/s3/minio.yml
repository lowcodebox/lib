version: '3.8'
#  ENV MINIO_ACCESS_KEY_FILE=access_key MINIO_SECRET_KEY_FILE=secret_key MINIO_ROOT_USER_FILE=access_key MINIO_ROOT_PASSWORD_FILE=secret_key MINIO_KMS_SECRET_KEY_FILE=kms_master_key MINIO_UPDATE_MINISIGN_PUBKEY=RWTx5Zr1tiHQLwG9keckT0c45M3AGeHD6IvimQHpyRywVWGbP1aVSGav MINIO_CONFIG_ENV_FILE=config.env MC_CONFIG_DIR=/tmp/.mc


services:
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"     # S3 API
      - "9001:9001"     # Web-консоль (по желанию)
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command:
        server /data --console-address ":9001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 5s
      timeout: 2s
      retries: 5

  integ-tests:
    image: golang:1.24.4-alpine
    container_name: s3-integration-tests
    working_dir: /go/src/app
    volumes:
      - ./:/go/src/app
    depends_on:
      minio:
        condition: service_healthy
    environment:
      # Эти переменные вы можете читать в тестах из os.Getenv,
      # либо просто напрямую жёстко прописать в ConfigS3
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_REGION: eu-central-1
      S3_ENDPOINT: http://minio:9000
      S3_DISABLE_SSL: "true"
      MINIO_ENDPOINT: minio:9000
    command: >
      sh -c "
        go mod download &&
        go test -timeout 120s -tags=integration ./s3 -v
      "
